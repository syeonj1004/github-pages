<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블록 이어쓰기 릴레이 (실시간 공유)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // =================================================================
    // [중요] 2단계에서 복사한 Firebase 설정값을 아래에 덮어씌우세요.
    // =================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyA3vOAoMcVQOebv9w5N0vx2CCMv40vZcjg",
        authDomain: "blockchain-relay-game.firebaseapp.com",
        projectId: "blockchain-relay-game",
        storageBucket: "blockchain-relay-game.firebasestorage.app",
        messagingSenderId: "1042703146204",
        appId: "1:1042703146204:web:822eb8d9f6f95bb071a819",
        measurementId: "G-D5MX29ZR50"
        };
    // =================================================================

    // Firebase 초기화
    if (!firebase.apps.length) {
        // 설정값이 비어있으면 경고 표시
        if (firebaseConfig.apiKey === "여기에_API_KEY_입력") {
            alert("HTML 파일을 열어 firebaseConfig 부분을 수정해주세요!");
        } else {
            firebase.initializeApp(firebaseConfig);
        }
    }
    
    // 안전하게 초기화되었을 때만 SDK 사용
    const auth = firebase.apps.length ? firebase.auth() : null;
    const db = firebase.apps.length ? firebase.firestore() : null;

    // --- 아이콘 컴포넌트 ---
    const LinkIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    );
    const AlertTriangleIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    );
    const CheckCircleIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
    );
    const RefreshCwIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
    );
    const PlayIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
    );
    const InfoIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
    );
    const GlobeIcon = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
    );

    // --- 메인 앱 컴포넌트 ---
    const BlockChainRelay = () => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        // 초기 블록 데이터
        const initialBlocks = Array.from({ length: 5 }, (_, i) => ({
            id: i + 1,
            studentName: `${i + 1}번 학생`,
            content: "",
            isGenesis: i === 0
        }));

        const [blocks, setBlocks] = useState(initialBlocks);
        const [isValidChain, setIsValidChain] = useState(true);
        const [statuses, setStatuses] = useState({});

        const demoScenario = [
            "사과",
            "사과 → 바나나",
            "사과 → 바나나 → 호랑이",
            "사과 → 바나나 → 호랑이 → 꿀벌",
            "사과 → 바나나 → 호랑이 → 꿀벌 → 물고기"
        ];

        // 1. 인증 처리
        useEffect(() => {
            if (!auth) return;
            const unsubscribe = auth.onAuthStateChanged((u) => {
                if (u) {
                    setUser(u);
                    setLoading(false);
                } else {
                    auth.signInAnonymously().catch((error) => {
                        console.error("Login failed:", error);
                        alert("로그인 설정 오류: Firebase Console에서 Authentication > 익명 로그인을 켜주세요.");
                    });
                }
            });
            return () => unsubscribe();
        }, []);

        // 2. 실시간 데이터 동기화
        useEffect(() => {
            if (!user || !db) return;

            // 데이터베이스 경로: game_sessions 컬렉션 -> class_room_1 문서
            const docRef = db.collection('game_sessions').doc('class_room_1');

            const unsubscribeSnapshot = docRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    if (data && data.blocks) {
                        setBlocks(data.blocks);
                    }
                } else {
                    docRef.set({ blocks: initialBlocks }, { merge: true });
                }
            }, (error) => {
                console.error("Sync error:", error);
                if (error.code === 'permission-denied') {
                    alert("권한 오류: Firebase Console에서 Firestore 규칙을 수정해주세요.");
                }
            });

            return () => unsubscribeSnapshot();
        }, [user]);

        // 3. 체인 검증 로직
        useEffect(() => {
            let allValid = true;
            const newStatuses = {};

            blocks.forEach((block, index) => {
                if (index === 0) {
                    const valid = block.content.trim().length > 0;
                    newStatuses[block.id] = valid;
                    if (!valid) allValid = false;
                } else {
                    const prevContent = blocks[index - 1].content.trim();
                    const currentContent = block.content.trim();
                    const isValidConnection = prevContent.length > 0 && currentContent.startsWith(prevContent);
                    newStatuses[block.id] = isValidConnection;
                    if (!isValidConnection) allValid = false;
                }
            });

            setStatuses(newStatuses);
            setIsValidChain(allValid);
        }, [blocks]);

        const saveToFirestore = async (newBlocks) => {
            if (!user || !db) return;
            try {
                await db.collection('game_sessions').doc('class_room_1').set({ blocks: newBlocks }, { merge: true });
            } catch (e) {
                console.error("Save error:", e);
            }
        };

        const updateBlock = (id, value) => {
            const newBlocks = blocks.map(b => b.id === id ? { ...b, content: value } : b);
            setBlocks(newBlocks);
            saveToFirestore(newBlocks);
        };

        const loadDemo = () => {
            if (!confirm("모든 사용자의 화면이 예시로 바뀝니다. 진행하시겠습니까?")) return;
            const newBlocks = blocks.map((b, i) => ({
                ...b,
                content: demoScenario[i] || ""
            }));
            setBlocks(newBlocks);
            saveToFirestore(newBlocks);
        };

        const resetBlocks = () => {
            if (!confirm("정말 초기화 하시겠습니까? 모든 사용자의 입력이 삭제됩니다.")) return;
            setBlocks(initialBlocks);
            saveToFirestore(initialBlocks);
        };

        const autoFillPrefix = (index) => {
            if (index === 0) return;
            const prevContent = blocks[index - 1].content;
            const currentContent = blocks[index].content;
            
            if (!currentContent.startsWith(prevContent)) {
                updateBlock(blocks[index].id, prevContent + " → ");
            }
        };

        if (loading) {
            return <div className="flex h-screen items-center justify-center text-lg font-bold text-slate-500">
                {auth ? "게임 접속 중..." : "설정을 확인해주세요 (Firebase Config)"}
            </div>;
        }

        return (
            <div className="min-h-screen p-4 md:p-8">
                <div className="max-w-4xl mx-auto">
                    
                    <header className="text-center mb-8">
                        <div className="inline-flex items-center gap-1 px-4 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-bold mb-2">
                            <GlobeIcon size={14} /> 실시간 전체 공유 모드
                        </div>
                        <h1 className="text-3xl md:text-4xl font-bold text-blue-600 mb-2 flex items-center justify-center gap-2">
                            <LinkIcon className="w-8 h-8" /> 블록 이어쓰기 릴레이
                        </h1>
                        <p className="text-slate-600 text-lg">
                            "앞 친구의 내용을 그대로 가져와야 블록이 연결됩니다!"
                        </p>
                    </header>

                    <div className="bg-white rounded-xl shadow-md p-4 mb-8 flex flex-wrap gap-4 justify-center items-center border border-slate-100">
                        <button 
                            onClick={loadDemo}
                            className="flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-colors shadow-sm"
                        >
                            <PlayIcon size={20} /> 예시 시작 (모두에게 반영)
                        </button>
                        <button 
                            onClick={resetBlocks}
                            className="flex items-center gap-2 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-slate-700 rounded-lg font-bold transition-colors"
                        >
                            <RefreshCwIcon size={20} /> 초기화 (모두에게 반영)
                        </button>
                    </div>

                    <div className={`mb-8 p-4 rounded-xl border-2 text-center font-bold text-lg transition-all duration-300 ${
                        isValidChain 
                            ? "bg-green-50 border-green-200 text-green-700" 
                            : "bg-red-50 border-red-200 text-red-600 animate-pulse"
                    }`}>
                        {isValidChain ? (
                            <span className="flex items-center justify-center gap-2">
                                <CheckCircleIcon /> 모든 블록이 안전하게 연결되어 있습니다!
                            </span>
                        ) : (
                            <span className="flex items-center justify-center gap-2">
                                <AlertTriangleIcon /> 체인 오류 발생! 누군가 내용을 바꿨거나 이어쓰기를 틀렸어요!
                            </span>
                        )}
                    </div>

                    <div className="space-y-4">
                        {blocks.map((block, index) => {
                            const status = statuses[block.id];
                            
                            return (
                                <div key={block.id} className="relative">
                                    {index > 0 && (
                                        <div className="flex justify-center -my-2 relative z-0">
                                            <div className={`w-1 h-8 ${status ? 'bg-blue-300' : 'bg-red-300 dashed border-r-2 border-l-2 border-transparent'}`}></div>
                                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-1 rounded-full border border-slate-200">
                                                <LinkIcon size={16} className={status ? "text-blue-400" : "text-red-400"} />
                                            </div>
                                        </div>
                                    )}

                                    <div className={`
                                        relative z-10 p-6 rounded-2xl border-4 transition-all duration-300 shadow-lg
                                        ${status 
                                            ? "bg-white border-blue-400" 
                                            : "bg-red-50 border-red-500 ring-4 ring-red-100"}
                                    `}>
                                        <div className="flex flex-col md:flex-row md:items-center gap-4">
                                            
                                            <div className="flex items-center gap-3 w-full md:w-32 shrink-0">
                                                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-inner
                                                    ${status ? 'bg-blue-500' : 'bg-red-500'}
                                                `}>
                                                    {block.id}
                                                </div>
                                                <div className="font-bold text-slate-700">{block.studentName}</div>
                                            </div>

                                            <div className="flex-1 relative">
                                                <div className="flex gap-2 mb-1">
                                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                        Block Data
                                                    </label>
                                                    {!status && index > 0 && (
                                                        <span className="text-xs font-bold text-red-500 animate-bounce">
                                                            ⚠️ 이전 블록 내용과 다릅니다!
                                                        </span>
                                                    )}
                                                </div>
                                                
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={block.content}
                                                        onChange={(e) => updateBlock(block.id, e.target.value)}
                                                        placeholder={index === 0 ? "예: 사과" : "이전 내용을 포함해서 이어 써주세요!"}
                                                        className={`w-full p-3 text-lg font-medium rounded-lg border-2 focus:outline-none focus:ring-2 transition-colors
                                                            ${status 
                                                                ? "border-slate-200 focus:border-blue-500 focus:ring-blue-200" 
                                                                : "border-red-300 bg-red-50 text-red-700 focus:border-red-500 focus:ring-red-200 placeholder-red-300"}
                                                        `}
                                                    />
                                                    {index > 0 && (
                                                        <button 
                                                            onClick={() => autoFillPrefix(index)}
                                                            className="shrink-0 px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors"
                                                            title="앞 내용 가져오기"
                                                        >
                                                            앞 내용<br/>가져오기
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="hidden md:flex w-12 justify-center">
                                                {status ? (
                                                    <CheckCircleIcon className="text-green-500 w-8 h-8" />
                                                ) : (
                                                    <AlertTriangleIcon className="text-red-500 w-8 h-8" />
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="mt-12 bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                        <h2 className="text-xl font-bold text-indigo-800 mb-4 flex items-center gap-2">
                            <InfoIcon /> 실시간 공유 안내
                        </h2>
                        <ul className="list-disc list-inside text-indigo-700 space-y-2">
                            <li>이 페이지에 접속한 <strong>모든 사용자</strong>가 하나의 화면을 공유합니다.</li>
                            <li>내가 입력하면 친구의 화면에도 <strong>즉시</strong> 반영됩니다.</li>
                            <li>[예시 시작] 버튼을 누르면 모든 사용자의 화면에 예시가 입력됩니다.</li>
                        </ul>
                    </div>

                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BlockChainRelay />);
</script>

</body>
</html>