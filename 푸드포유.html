<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ì¶¤í˜• ìŒì‹ ë©”ë‰´ ì¶”ì²œ v2.0</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Custom Variables (Light Mode) --- */
        :root {
            --primary-bg: #EF4444; /* Red-500 */
            --primary-text: #FFFFFF;
            --body-bg: #FEE2E2; /* Red-100 */
            --card-bg: #FFFFFF;
            --text-color: #1F2937; /* Gray-800 */
            --subtle-bg: #F9FAFB; /* Gray-50 */
            --border-color: #FEE2E2; /* Red-100 */
            --dynamic-color: #FFB6C1; /* Default Pastel Light Pink */
            /* ìš”ì²­ì— ë”°ë¥¸ ì¶”ê°€ ë³€ìˆ˜: ì¹´ë“œ í…Œë‘ë¦¬ ìƒ‰ìƒ */
            --card-edge-color: #FFFFFF; /* Light Mode: White edge (í°ìƒ‰) */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Subtle dark shadow */
        }

        /* --- Dark Mode Variables --- */
        [data-theme='dark'] {
            --primary-bg: #DC2626; /* Red-600 */
            --primary-text: #FEE2E2;
            --body-bg: #111827; /* Gray-900 */
            --card-bg: #1F2937; /* Gray-800 */
            --text-color: #F3F4F6; /* Gray-100 */
            --subtle-bg: #374151; /* Gray-700 */
            --border-color: #374151; /* Gray-700 */
            --dynamic-color: #B0E0E6; /* Default Pastel Powder Blue */
            /* ìš”ì²­ì— ë”°ë¥¸ ì¶”ê°€ ë³€ìˆ˜: ì¹´ë“œ í…Œë‘ë¦¬ ìƒ‰ìƒ */
            --card-edge-color: #000000; /* Dark Mode: Black edge (ê²€ì •ìƒ‰) */
            --shadow-color: rgba(255, 255, 255, 0.05); /* Subtle light shadow */
        }

        /* --- Global Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--body-bg);
            color: var(--text-color);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        .container-card {
            background-color: var(--card-bg);
            /* í…Œë‘ë¦¬ ë°°ê²½ìƒ‰ ìš”ì²­ì— ë”°ë¼ box-shadow ìˆ˜ì • (4px í°ìƒ‰/ê²€ì€ìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼) */
            box-shadow: 0 0 0 4px var(--card-edge-color), 
                        0 10px 30px -5px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        /* --- Dynamic Header & Button Styling --- */
        #header-banner {
            background-color: var(--dynamic-color);
            transition: background-color 0.5s ease-in-out;
            /* í—¤ë” í…ìŠ¤íŠ¸ê°€ íŒŒìŠ¤í…” í†¤ì—ì„œë„ ì˜ ë³´ì´ë„ë¡ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì•½ê°„ ì–´ë‘¡ê²Œ ì„¤ì • */
            color: var(--text-color); 
        }
        /* í—¤ë” í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì˜¤ë²„ë¼ì´ë“œ (íŒŒìŠ¤í…” í†¤ ë°°ê²½ì— ì˜ ë³´ì´ë„ë¡) */
        #header-banner h1, #header-banner p {
            color: var(--text-color) !important;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3); /* ë°ì€ ë°°ê²½ì—ì„œ ê°€ë…ì„± í–¥ìƒ */
        }
        [data-theme='dark'] #header-banner h1, [data-theme='dark'] #header-banner p {
            color: #1F2937 !important; /* Dark modeì—ì„œ íŒŒìŠ¤í…” ë°°ê²½ ì‚¬ìš© ì‹œ, í…ìŠ¤íŠ¸ëŠ” ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ */
            text-shadow: none;
        }

        .btn-primary {
            background-color: var(--dynamic-color);
            /* ë²„íŠ¼ í…ìŠ¤íŠ¸ëŠ” ì–´ë‘¡ê²Œ ì„¤ì •í•˜ì—¬ íŒŒìŠ¤í…” ë°°ê²½ì—ì„œ ì˜ ë³´ì´ë„ë¡ ì¡°ì • */
            color: var(--text-color); 
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-primary:hover {
            opacity: 0.8;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .text-dynamic {
            color: var(--dynamic-color);
        }
        
        /* --- Recommendation Result Styling --- */
        .result-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .recipe-box {
            background-color: var(--subtle-bg);
            border: 1px solid var(--border-color);
        }
        
        /* --- Loading Spinner --- */
        .spinner {
            border-top-color: var(--dynamic-color);
            border-left-color: var(--dynamic-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        
        <!-- Header Banner & Theme Toggle -->
        <header id="header-banner" class="rounded-t-xl text-center py-8 px-6 mb-4 shadow-lg flex justify-between items-start">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2">ì˜¤ëŠ˜ì˜ ë©”ë‰´ ì¶”ì²œ ğŸ§‘â€ğŸ³</h1>
                <p class="text-base">ìƒí™©, ê¸°ë¶„, ì¬ë£Œ ë“±ì„ ì…ë ¥í•˜ë©´ ë”± ë§ëŠ” ìŒì‹ì„ ì°¾ì•„ë“œë ¤ìš”!</p>
            </div>
            
            <!-- Dark Mode Toggle -->
            <button id="theme-toggle" onclick="toggleTheme()" class="p-3 rounded-full bg-black bg-opacity-10 hover:bg-opacity-20 transition duration-200 focus:outline-none focus:ring-2 focus:ring-white">
                <!-- Icon will be updated by JS -->
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- Main Content Card -->
        <div class="container-card p-6 md:p-8 rounded-b-xl">
            
            <!-- 1. Input Section -->
            <section class="mb-8 border-b pb-6 border-red-200 dark:border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-dynamic" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    ì¶”ì²œ ì¡°ê±´ ì…ë ¥ (ìƒí™©, ê¸°ë¶„, ë‚ ì”¨, ì¬ë£Œ, ì‹œê°„ ë“±)
                </h2>

                <!-- Input Field -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <input type="text" id="criteria-input" placeholder="ì˜ˆ: ìƒí™©: ë¹„ ì˜¤ëŠ” ë‚ , ê¸°ë¶„: ìš°ìš¸í•œ, ì¬ë£Œ: ë¼ì§€ê³ ê¸°" 
                           class="md:col-span-3 lg:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 shadow-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                           onkeydown="handleInputKey(event)">
                    <button id="add-btn" onclick="addCriteria()" class="btn-primary font-medium py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 md:col-span-1 lg:col-span-1">
                        ì¡°ê±´ ì¶”ê°€
                    </button>
                    <button id="recommend-btn" onclick="fetchRecommendation()" class="btn-primary font-medium py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 md:col-span-1 lg:col-span-1" disabled>
                        ë©”ë‰´ ì¶”ì²œ ë°›ê¸°
                    </button>
                </div>

                <!-- Criteria Tags Display -->
                <div>
                    <p class="text-sm font-medium mb-2 text-gray-500 dark:text-gray-400">í˜„ì¬ ì¡°ê±´ (<span id="criteria-count">0</span>ê°œ):</p>
                    <div id="criteria-tags" class="flex flex-wrap gap-2 min-h-[3rem] p-3 border border-dashed rounded-xl bg-gray-50 dark:bg-gray-700 border-dynamic">
                        <!-- Tags will be dynamically inserted here -->
                        <p id="empty-message" class="text-gray-500 dark:text-gray-400 italic text-sm self-center">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  'ì¡°ê±´ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            </section>

            <!-- 2. Recommendation Section -->
            <section>
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-dynamic" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v2m0 0a3 3 0 003-3H9a3 3 0 003 3zm7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ì¶”ì²œ ê²°ê³¼
                </h2>

                <div id="recommendation-output" class="p-6 result-card rounded-xl min-h-48 flex items-center justify-center text-center border-2 border-dashed border-gray-200 dark:border-gray-700">
                    <p class="text-gray-500 dark:text-gray-400">ì¡°ê±´ì„ ì…ë ¥í•œ í›„, ë©”ë‰´ ì¶”ì²œ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                </div>

            </section>
        </div>

    </div>

    <script>
        // API Configuration 
        const apiKey = ""; 
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";

        // Application State
        let criteriaList = [];
        let isFetching = false;
        
        // Dynamic Color Palettes: íŒŒìŠ¤í…” í†¤ìœ¼ë¡œ ë³€ê²½
        const DYNAMIC_COLORS = [
            '#FFB6C1', // Light Pink
            '#B0E0E6', // Powder Blue
            '#C1E1C1', // Mint Green
            '#FDFD96', // Light Yellow
            '#E6E6FA', // Lavender
            '#FFA07A', // Light Salmon
        ];

        // UI Element References
        const htmlElement = document.documentElement;
        const criteriaInput = document.getElementById('criteria-input');
        const criteriaTagsDiv = document.getElementById('criteria-tags');
        const criteriaCountSpan = document.getElementById('criteria-count');
        const emptyMessage = document.getElementById('empty-message');
        const recommendBtn = document.getElementById('recommend-btn');
        const recommendationOutput = document.getElementById('recommendation-output');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const headerBanner = document.getElementById('header-banner');

        // --- Theme Toggle Logic ---
        
        /**
         * Updates the theme icon visibility.
         * @param {string} theme - 'light' or 'dark'.
         */
        function updateThemeToggle(theme) {
            // í—¤ë” ìƒ‰ìƒì´ ë°ì€ íŒŒìŠ¤í…”í†¤ì´ë¯€ë¡œ í† ê¸€ ì•„ì´ì½˜ ìƒ‰ìƒì„ ì–´ë‘¡ê²Œ ì¡°ì •
            const iconColor = theme === 'dark' ? 'text-gray-100' : 'text-gray-800';
            
            themeIconLight.classList.toggle('hidden', theme === 'dark');
            themeIconDark.classList.toggle('hidden', theme !== 'dark');
            
            // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ ìƒ‰ìƒ ì„¤ì •
            [themeIconLight, themeIconDark].forEach(icon => {
                icon.classList.remove('text-white', 'text-gray-100', 'text-gray-800');
                icon.classList.add(iconColor);
            });
        }

        /**
         * Toggles between light and dark mode.
         */
        function toggleTheme() {
            const isDark = htmlElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }

        // --- Dynamic Styling Functions ---

        /**
         * Sets the dynamic color for the header and primary buttons.
         * @param {string} colorHex - Hex color string (e.g., '#F97316').
         */
        function setDynamicHeaderColor(colorHex) {
            htmlElement.style.setProperty('--dynamic-color', colorHex);
        }

        /**
         * Picks a random color from the predefined palette.
         * @returns {string} The selected hex color.
         */
        function getRandomDynamicColor() {
            const randomIndex = Math.floor(Math.random() * DYNAMIC_COLORS.length);
            return DYNAMIC_COLORS[randomIndex];
        }


        // --- Utility Functions ---

        /**
         * Renders the current list of criteria as removable tags in the UI.
         */
        function renderCriteria() {
            criteriaTagsDiv.innerHTML = '';
            
            if (criteriaList.length === 0) {
                emptyMessage.style.display = 'block';
                recommendBtn.disabled = true;
            } else {
                emptyMessage.style.display = 'none';
                recommendBtn.disabled = isFetching;
                
                const dynamicColor = htmlElement.style.getPropertyValue('--dynamic-color') || '#FFB6C1';
                
                criteriaList.forEach((criteria, index) => {
                    const tag = document.createElement('div');
                    // íŒŒìŠ¤í…” í†¤ê³¼ ëŒ€ë¹„ë˜ëŠ” ìƒ‰ìƒìœ¼ë¡œ íƒœê·¸ ë°°ê²½ ì„¤ì •
                    const tagBg = htmlElement.getAttribute('data-theme') === 'dark' ? 'bg-gray-600' : 'bg-gray-200';
                    const tagText = htmlElement.getAttribute('data-theme') === 'dark' ? 'text-gray-100' : 'text-gray-800';
                    const tagRemoveColor = htmlElement.getAttribute('data-theme') === 'dark' ? 'text-gray-300' : 'text-gray-600';

                    tag.className = `flex items-center ${tagBg} ${tagText} text-sm font-semibold px-3 py-1 rounded-full whitespace-nowrap shadow-sm`;
                    tag.innerHTML = `
                        <span>${criteria}</span>
                        <button onclick="removeCriteria(${index})" class="tag-remove-btn ml-2 ${tagRemoveColor} hover:text-gray-800 focus:outline-none dark:hover:text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    criteriaTagsDiv.appendChild(tag);
                });
            }

            criteriaCountSpan.textContent = criteriaList.length;
        }

        /**
         * Adds a new criteria from the input field to the list.
         */
        function addCriteria() {
            const criteria = criteriaInput.value.trim();
            if (criteria && !criteriaList.includes(criteria)) {
                criteriaList.push(criteria);
                criteriaInput.value = '';
                renderCriteria();
            }
        }

        /**
         * Removes a criteria by its index from the list.
         * @param {number} index - The index of the criteria to remove.
         */
        function removeCriteria(index) {
            criteriaList.splice(index, 1);
            renderCriteria();
        }

        /**
         * Handles the Enter key press in the input field to add criteria.
         * @param {KeyboardEvent} event 
         */
        function handleInputKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCriteria();
            }
        }

        /**
         * Displays a loading spinner and message.
         */
        function showLoading() {
            isFetching = true;
            recommendBtn.disabled = true;
            recommendBtn.textContent = 'ì¶”ì²œ ì¤‘...';
            
            const dynamicColor = htmlElement.style.getPropertyValue('--dynamic-color');

            recommendationOutput.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="spinner border-4 h-12 w-12 rounded-full border-gray-200 dark:border-gray-600 border-t-4 mb-3" style="border-top-color: ${dynamicColor}; border-left-color: ${dynamicColor};"></div>
                    <p class="text-lg font-medium text-dynamic" style="color: ${dynamicColor}">ìµœì ì˜ ë©”ë‰´ë“¤ì„ ê³ ë¥´ê³  ìˆì–´ìš”...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">ì´ ê³¼ì •ì€ ëª‡ ì´ˆê°€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;
        }

        /**
         * Displays the recommendation results.
         * @param {Array} recommendations - The parsed JSON array of recommendation objects.
         * @param {Array} sources - Array of web sources (citations).
         */
        function showResult(recommendations, sources) {
            
            // Set new dynamic color after success
            setDynamicHeaderColor(getRandomDynamicColor());
            
            if (!Array.isArray(recommendations) || recommendations.length === 0) {
                showError("ì¶”ì²œ ë©”ë‰´ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¡°ê±´ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            // --- 1. Count/Title (ê°€ì¥ ìœ„ìª½ì— ë°°ì¹˜) ---
            const dynamicColor = htmlElement.style.getPropertyValue('--dynamic-color');
            let htmlContent = `
                <h3 class="text-3xl font-extrabold text-dynamic mb-6 text-center" style="color: ${dynamicColor}">âœ¨ ì¶”ì²œ ë©”ë‰´ ${recommendations.length}ê°€ì§€ âœ¨</h3>

                <!-- 2. Recommendation List -->
                <div class="space-y-6 text-left mb-6">
            `;

            // Loop through each recommendation
            recommendations.forEach((item, index) => {
                const { foodName, emoji, recipe } = item;
                
                htmlContent += `
                    <div class="result-card p-5 rounded-xl shadow-lg border border-dynamic dark:border-gray-700">
                        <div class="flex items-center mb-3 border-b pb-2 border-dynamic border-opacity-30">
                            <span class="text-4xl mr-3">${emoji}</span>
                            <h4 class="text-2xl font-bold text-dynamic" style="color: ${dynamicColor}">#${index + 1}. ${foodName}</h4>
                        </div>
                        
                        <div class="mt-4">
                            <p class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-dynamic" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: ${dynamicColor}">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                                ê°„ë‹¨ ë ˆì‹œí”¼
                            </p>
                            <div class="recipe-box p-3 rounded-lg border">
                                <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">${recipe}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            htmlContent += `</div>`; // Close space-y-6 container

            // Add source citation area
            const sourceList = sources.map(s => `<a href="${s.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline truncate block text-xs dark:text-blue-400 dark:hover:text-blue-300">${s.title || s.uri}</a>`).join('');

            if (sources.length > 0) {
                htmlContent += `
                    <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 text-left">
                        <h4 class="text-sm font-semibold mb-1 text-gray-600 dark:text-gray-400">ğŸ” ì°¸ê³  ì •ë³´ ì¶œì²˜</h4>
                        <div class="space-y-1">${sourceList}</div>
                    </div>
                `;
            }

            recommendationOutput.innerHTML = htmlContent;
        }
        
        /**
         * Displays an error message.
         * @param {string} message - The error message.
         */
        function showError(message) {
            recommendationOutput.innerHTML = `
                <div class="text-center p-6 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 rounded-lg">
                    <p class="text-red-700 dark:text-red-300 font-bold mb-2">ğŸ˜­ ì¶”ì²œ ì‹¤íŒ¨</p>
                    <p class="text-sm text-red-600 dark:text-red-400">${message}</p>
                    <p class="text-xs text-red-500 dark:text-red-500 mt-2">API í‚¤ ì„¤ì • ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // --- Gemini API Logic ---

        /**
         * Fetches a food recommendation from the Gemini API with structured output.
         */
        async function fetchRecommendation() {
            if (isFetching || criteriaList.length === 0) return;
            showLoading();

            const prompt = `ì‚¬ìš©ìì˜ ìš”ì²­ ì¡°ê±´ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ì–‘í•˜ê³  ê°€ì¥ ì í•©í•œ í•œêµ­ ìŒì‹ ë©”ë‰´ 3ê°€ì§€(ì„œë¡œ ë‹¤ë¥¸ ì¢…ë¥˜)ë¥¼ ì¶”ì²œí•˜ê³ , ê° ìŒì‹ì˜ ì‰½ê³  ê°„ë‹¨í•œ ë ˆì‹œí”¼ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ JSON ë°°ì—´ë¡œ ì œê³µí•˜ì„¸ìš”. **ì¶”ì²œë˜ëŠ” 3ê°€ì§€ ë©”ë‰´ëŠ” ì´ë¦„ê³¼ ì¢…ë¥˜ê°€ ëª¨ë‘ ì¤‘ë³µë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.**

            ìš”ì²­ ì¡°ê±´: ${criteriaList.join(', ')}
            `;

            const responseSchema = {
                type: "ARRAY",
                description: "ì‚¬ìš©ì ì¡°ê±´ì— ë§ëŠ” 3ê°€ì§€ ìŒì‹ ì¶”ì²œ ëª©ë¡",
                items: {
                    type: "OBJECT",
                    properties: {
                        "foodName": { "type": "STRING", "description": "ì¶”ì²œí•  ìŒì‹ì˜ ì´ë¦„ (í•œêµ­ì–´)" },
                        "emoji": { "type": "STRING", "description": "ìŒì‹ì„ ë‚˜íƒ€ë‚´ëŠ” ì´ëª¨ì§€ (ì˜ˆ: ğŸœ)" },
                        "recipe": { "type": "STRING", "description": "ìŒì‹ì— ëŒ€í•œ ìƒì„¸í•˜ê³  ê°„ë‹¨í•œ ë ˆì‹œí”¼ ì„¤ëª… (Markdown í˜•ì‹ í¬í•¨ ê°€ëŠ¥)" }
                    },
                    propertyOrdering: ["foodName", "emoji", "recipe"]
                }
            };

            // ì‹œìŠ¤í…œ ëª…ë ¹ì–´: ìˆ˜ì •ëœ ë””ì €íŠ¸ í¬í•¨ ê·œì¹™ ìœ ì§€
            const systemInstruction = "ë‹¹ì‹ ì€ í•œêµ­ ìŒì‹ ì „ë¬¸ ì…°í”„ì´ì AI ì¶”ì²œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ë‹¤ì–‘í•œ ì¡°ê±´(ìƒí™©, ê¸°ë¶„, ì¬ë£Œ, ë‚ ì”¨, ì‹œê°„ ë“±)ì— ë¶€í•©í•˜ëŠ” ë©”ë‰´ 3ê°€ì§€ë¥¼ ì„ ì •í•˜ì—¬, ì´ë¦„, ê´€ë ¨ ì´ëª¨ì§€, ê·¸ë¦¬ê³  ìì„¸í•œ ë ˆì‹œí”¼ë¥¼ í¬í•¨í•˜ëŠ” JSON ë°°ì—´ ì‘ë‹µì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. \
            - ë§Œì•½ ì¡°ê±´ì— 'ë””ì €íŠ¸', 'í›„ì‹', 'ê°„ì‹'ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´, **3ê°€ì§€ ë””ì €íŠ¸**ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. \
            - ê·¸ë ‡ì§€ ì•Šë‹¤ë©´, **2ê°€ì§€ ë‹¤ë¥¸ ë©”ì¸ ìš”ë¦¬** (ì°Œê°œ/êµ­, ë³¶ìŒ/êµ¬ì´, ë©´/ë°¥ ë“±)ì™€ **1ê°€ì§€ ë‹¤ì–‘í•œ ë‚˜ë¼ì˜ ë””ì €íŠ¸**ë¥¼ í¬í•¨í•˜ì—¬ ì´ 3ê°€ì§€ ë©”ë‰´ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. \
            ì¶”ì²œë˜ëŠ” 3ê°€ì§€ ë©”ë‰´ëŠ” ìš”ë¦¬ ì¢…ë¥˜ê°€ ì¤‘ë³µë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤. ë ˆì‹œí”¼ëŠ” ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰¬ì›Œì•¼ í•©ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ì„¸ìš”.";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const MAX_RETRIES = 2;
            let attempt = 0;

            const apiUrl = `${API_BASE_URL}${MODEL_NAME}:generateContent?key=${apiKey}`;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];
                    const jsonText = candidate?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                         throw new Error("API ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }

                    // 1. Extract and Parse JSON (ê²°ê³¼ëŠ” ë°°ì—´)
                    const recommendationData = JSON.parse(jsonText);

                    // 2. Extract Grounding Sources (íˆ´ì´ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ë¹ˆ ë°°ì—´)
                    let sources = [];
                    const groundingMetadata = candidate?.groundingMetadata;
                    if (groundingMetadata?.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri); 
                    }
                    
                    // Display the result and exit the loop
                    showResult(recommendationData, sources);
                    return; // Success, exit function

                } catch (error) {
                    console.error(`API Call Attempt ${attempt + 1} Failed:`, error);
                    attempt++;

                    if (attempt < MAX_RETRIES) {
                        const delay = Math.pow(2, attempt) * 1000;
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // All retries failed
                        showError("ë©”ë‰´ ì¶”ì²œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                    }
                } finally {
                    isFetching = false;
                    recommendBtn.textContent = 'ë©”ë‰´ ì¶”ì²œ ë°›ê¸°';
                    renderCriteria();
                }
            }
        }

        // --- Initialization ---
        window.onload = () => {
            // 1. Load Theme from Local Storage
            const storedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            htmlElement.setAttribute('data-theme', storedTheme);
            updateThemeToggle(storedTheme);
            
            // 2. Set initial dynamic color (default pastel)
            setDynamicHeaderColor(getRandomDynamicColor()); 

            // 3. Render initial criteria state
            renderCriteria();
        };

    </script>
</body>
</html>